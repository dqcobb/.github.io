<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QR Code æ™ºæ…§æ‰«æè·³è½¬å™¨</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
:root { --primary-color: #007bff; --success-color: #28a745; --error-color: #dc3545; }
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f2f4f8;
    color: #333;
}
.container { max-width: 480px; margin: auto; padding: 20px; }
.card {
    background: #fff;
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
}
h1 { font-size: 24px; margin-bottom: 8px; color: #1a1a1a; }
p { font-size: 14px; color: #666; margin-bottom: 24px; }

/* æŒ‰é’®æ ·å¼ */
.btn {
    display: block;
    width: 100%;
    height: 56px;
    line-height: 56px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 14px;
    border: none;
    margin: 12px 0;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
    text-decoration: none;
}
.btn-upload { background: var(--primary-color); color: white; }
.btn-camera { background: #333; color: white; }
.btn:active { transform: scale(0.98); opacity: 0.9; }

#status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 12px;
    font-size: 15px;
    min-height: 40px;
    word-break: break-all;
    background: #f8f9fa;
}

/* å½±ç‰‡ä¸ç”»å¸ƒ */
video {
    width: 100%;
    margin-top: 16px;
    border-radius: 16px;
    display: none;
    background: #000;
}
canvas { display: none; }

/* è½½å…¥åŠ¨ç”» */
.spinner {
    display: none;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(0,123,255,.2);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>

<body>
<div class="container">
    <div class="card">
        <h1>QR Code è‡ªåŠ¨è·³è½¬</h1>
        <p>æ”¯æ´ç©¿é€åŒºåŸŸå°é” (ScraperAPI)</p>

        <label class="btn btn-upload">
            ğŸ“ é€‰æ‹©å›¾ç‰‡ / æ‹ç…§
            <input type="file" accept="image/*" hidden id="upload">
        </label>

        <button class="btn btn-camera" onclick="startCamera()">ğŸ“· å¼€å¯ç›¸æœºæ‰«æ</button>

        <div id="loader" class="spinner"></div>
        <div id="status">å‡†å¤‡å°±ç»ªï¼Œè¯·æ“ä½œ</div>

        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
const upload = document.getElementById("upload");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const status = document.getElementById("status");
const loader = document.getElementById("loader");

// ==========================================
// 1. è®¾å®šåŒºï¼šå¡«å…¥ä½ çš„ ScraperAPI Key
// ==========================================
const SCRAPER_API_KEY = "5ddbe6f1681816637ad2856f7c3d56b2"; 

let scanning = false;

/* ===== æ¯æ—¥ Log ç³»ç»Ÿ ===== */
const today = new Date().toISOString().slice(0,10);
const STORAGE_KEY = "QR_LOG_" + today;
let logs = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

function saveLog(source, content){
    const time = new Date().toLocaleString("zh-TW",{hour12:false});
    logs.push({ time, source, content });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    
    // äº§ç”Ÿå¹¶è§¦å‘ä¸‹è½½ CSV (é™é»˜çºªå½•)
    let csv = "æ—¥æœŸ,æ—¶é—´,æ¥æº,å†…å®¹\n";
    logs.forEach(l => csv += `${today},${l.time},${l.source},"${l.content}"\n`);
    const blob = new Blob(["\ufeff" + csv], { type:"text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `QR_Log_${today}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

/* ===== æ ¸å¿ƒè·³è½¬é€»è¾‘ (ScraperAPI ä¸­è½¬) ===== */
function handleRedirect(qrData) {
    if (qrData.startsWith('http')) {
        loader.style.display = "block";
        status.innerHTML = `<b style="color:var(--success-color)">è¾¨è¯†æˆåŠŸï¼</b><br>æ­£åœ¨ä½¿ç”¨é«˜çº§ç©¿é€æ¨¡å¼...`;
        
        // ä¿®æ”¹é‡ç‚¹ï¼šåŠ å…¥ premium=true ä»¥åŠ render=true
        // premium=true: ä½¿ç”¨ä½å®… IPï¼Œæ¨¡ä»¿çœŸå®äººç±»ç”¨æˆ·ï¼Œèƒ½ç ´è§£ 99% çš„å°é”
        // render=true: è®© ScraperAPI å…ˆå¸®ä½ è·‘å®Œ JavaScript (å¦‚æœç›®æ ‡ç½‘ç«™æœ‰æµè§ˆå™¨æ£€æŸ¥)
        const finalUrl = `https://api.scraperapi.com?api_key=${SCRAPER_API_KEY}&url=${encodeURIComponent(qrData)}&country_code=us&device_type=mobile&premium=true&render=true`;

        setTimeout(() => {
            window.location.href = finalUrl;
        }, 1500);
    } else {
        status.innerHTML = `<b style="color:var(--error-color)">å†…å®¹éç½‘å€ï¼š</b><br>${qrData}`;
    }
}

/* ===== å½±åƒè¾¨è¯†æ ¸å¿ƒ ===== */
function performScan(imageData) {
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "attemptBoth"
    });
    return code;
}

/* ===== å›¾ç‰‡ä¸Šä¼ å¤„ç† ===== */
upload.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    status.innerText = "å¤„ç†å›¾ç‰‡ä¸­...";
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            // ä¼˜åŒ–è¾¨è¯†é€Ÿåº¦ï¼Œç¼©æ”¾å¤§å‹æ‰‹æœºç…§ç‰‡
            let w = img.width, h = img.height, max = 1024;
            if (w > max || h > max) {
                const s = Math.min(max / w, max / h);
                w *= s; h *= s;
            }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            
            const result = performScan(ctx.getImageData(0, 0, w, h));
            if (result) {
                saveLog("Upload", result.data);
                handleRedirect(result.data);
            } else {
                status.innerHTML = `<b style="color:var(--error-color)">æ— æ³•è¾¨è¯† QR Code</b><br>è¯·æ¢å¼ æ›´æ¸…æ™°çš„ç…§ç‰‡ã€‚`;
            }
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

/* ===== ç›¸æœºå³æ—¶æ‰«æ ===== */
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = stream;
        video.style.display = "block";
        status.innerText = "ğŸ“· è¯·å°†äºŒç»´ç å¯¹å‡†ç›¸æœº";
        scanning = true;
        requestAnimationFrame(loop);
    } catch (err) {
        status.innerHTML = `<b style="color:var(--error-color)">ç›¸æœºå¼€å¯å¤±è´¥</b><br>è¯·ç¡®ä¿ä½¿ç”¨ HTTPS å¹¶æˆæƒç›¸æœºæƒé™ã€‚`;
    }
}

function loop() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        const result = performScan(ctx.getImageData(0, 0, canvas.width, canvas.height));
        if (result) {
            scanning = false;
            saveLog("Camera", result.data);
            video.srcObject.getTracks().forEach(t => t.stop());
            video.style.display = "none";
            handleRedirect(result.data);
            return;
        }
    }
    requestAnimationFrame(loop);
}
</script>
</body>
</html>


